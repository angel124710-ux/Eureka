--[[
    Universal Lock Controller para TSB
    - PC: P (cam lock) | L (character lock)
    - Mobile: Bot√£o √∫nico + switch P/L
]]

_G.CharLockEnabled = _G.CharLockEnabled or false
_G.CamLockEnabled = _G.CamLockEnabled or false

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local pGui = player:WaitForChild("PlayerGui")

-- Detectar plataforma
local function isMobile()
    return UserInputService.TouchEnabled and not UserInputService.MouseEnabled
end

-- Limpar GUIs antigas
local function cleanup()
    local old = pGui:FindFirstChild("MobileLockController")
    if old then old:Destroy() end
end

-- Criar UI apenas para mobile
if isMobile() then
    cleanup()
    
    -- ==============================================
    -- 1. LOCALIZAR O BOT√ÉO ORIGINAL
    -- ==============================================
    local originalButton = nil
    local contextFrame = pGui:FindFirstChild("ContextActionGui") and 
                         pGui.ContextActionGui:FindFirstChild("ContextButtonFrame")
    
    if contextFrame then
        local buttons = contextFrame:GetChildren()
        table.sort(buttons, function(a, b) return a.Name < b.Name end)
        -- O script original j√° destruiu 2 bot√µes, sobra 1
        originalButton = buttons[1]
    end
    
    if not originalButton then
        warn("Bot√£o original n√£o encontrado. Ainda assim, criaremos a UI.")
    end
    
    -- ==============================================
    -- 2. CRIAR NOSSA PR√ìPRIA UI
    -- ==============================================
    local sg = Instance.new("ScreenGui")
    sg.Name = "MobileLockController"
    sg.Parent = pGui
    sg.ResetOnSpawn = false
    sg.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    sg.IgnoreGuiInset = true
    
    -- Frame principal (opcional, para agrupar)
    local mainFrame = Instance.new("Frame")
    mainFrame.Parent = sg
    mainFrame.Size = UDim2.new(0, 200, 0, 120)
    mainFrame.Position = UDim2.new(0.5, -100, 0.8, -60) -- Inicial no centro inferior
    mainFrame.BackgroundTransparency = 1
    mainFrame.Active = true
    mainFrame.Draggable = true -- permite arrastar o conjunto
    
    -- ==============================================
    -- 3. BOT√ÉO GRANDE (c√≥pia do original)
    -- ==============================================
    local bigButton = Instance.new("TextButton")
    bigButton.Parent = mainFrame
    bigButton.Size = UDim2.new(0, 80, 0, 80) -- tamanho pr√≥ximo ao original
    bigButton.Position = UDim2.new(0, 10, 0, 10)
    bigButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0) -- vermelho padr√£o
    bigButton.Text = "LOCK"
    bigButton.TextColor3 = Color3.new(1,1,1)
    bigButton.Font = Enum.Font.GothamBold
    bigButton.TextSize = 16
    bigButton.AutoButtonColor = false
    
    -- Se o original existir, copia a apar√™ncia
    if originalButton then
        bigButton.BackgroundColor3 = originalButton.BackgroundColor3
        bigButton.Text = originalButton.Text
        bigButton.Font = originalButton.Font
        bigButton.TextSize = originalButton.TextSize
        bigButton.Size = originalButton.Size
        bigButton.Position = originalButton.Position -- usa a posi√ß√£o original
        -- Esconde o original
        originalButton.Visible = false
    end
    
    -- Cantos arredondados
    local bigCorner = Instance.new("UICorner")
    bigCorner.Parent = bigButton
    bigCorner.CornerRadius = UDim.new(0, 12)
    
    -- ==============================================
    -- 4. SWITCH (P/L)
    -- ==============================================
    local mode = "L" -- L = character, P = camera (padr√£o L)
    
    local switchFrame = Instance.new("Frame")
    switchFrame.Parent = mainFrame
    switchFrame.Size = UDim2.new(0, 40, 0, 40)
    switchFrame.Position = UDim2.new(0, 100, 0, 30) -- ao lado do bot√£o
    switchFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    switchFrame.BackgroundTransparency = 0.2
    switchFrame.Active = true
    switchFrame.Draggable = true -- pode arrastar separadamente
    
    local switchCorner = Instance.new("UICorner")
    switchCorner.Parent = switchFrame
    switchCorner.CornerRadius = UDim.new(1, 0) -- redondo
    
    local switchButton = Instance.new("TextButton")
    switchButton.Parent = switchFrame
    switchButton.Size = UDim2.new(1, 0, 1, 0)
    switchButton.BackgroundTransparency = 1
    switchButton.Text = mode
    switchButton.TextColor3 = Color3.fromRGB(0, 255, 255)
    switchButton.Font = Enum.Font.GothamBold
    switchButton.TextSize = 20
    switchButton.AutoButtonColor = false
    
    -- ==============================================
    -- 5. L√ìGICA DE ATUALIZA√á√ÉO DAS CORES
    -- ==============================================
    local function updateButtonColor()
        if mode == "L" then
            bigButton.BackgroundColor3 = _G.CharLockEnabled and 
                Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
        else -- mode "P"
            bigButton.BackgroundColor3 = _G.CamLockEnabled and 
                Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
        end
    end
    
    -- Monitorar mudan√ßas nas vari√°veis
    spawn(function()
        while true do
            task.wait(0.1)
            updateButtonColor()
        end
    end)
    
    -- ==============================================
    -- 6. EVENTO DO SWITCH (alternar modo)
    -- ==============================================
    switchButton.MouseButton1Click:Connect(function()
        mode = (mode == "L") and "P" or "L"
        switchButton.Text = mode
        updateButtonColor()
        
        -- Feedback visual
        TweenService:Create(switchFrame, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(80, 80, 80)}):Play()
        task.wait(0.1)
        TweenService:Create(switchFrame, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(30, 30, 30)}):Play()
    end)
    
    -- ==============================================
    -- 7. EVENTO DO BOT√ÉO GRANDE (alternar fun√ß√£o)
    -- ==============================================
    bigButton.MouseButton1Click:Connect(function()
        if mode == "L" then
            -- Character lock
            _G.CharLockEnabled = not _G.CharLockEnabled
            if _G.CharacterLock then
                _G.CharacterLock(_G.CharLockEnabled)
            end
        else -- mode "P"
            -- Camera lock
            _G.CamLockEnabled = not _G.CamLockEnabled
            if _G.CameraLock then
                _G.CameraLock(_G.CamLockEnabled)
            end
        end
        updateButtonColor()
        
        -- Feedback de clique
        bigButton.TextSize = 18
        task.wait(0.1)
        bigButton.TextSize = 16
    end)
    
    -- ==============================================
    -- 8. GARANTIR QUE O BOT√ÉO ORIGINAL N√ÉO APARE√áA
    -- ==============================================
    if originalButton then
        originalButton.Visible = false
    end
    
    print("üì± Mobile UI carregada. Use o switch P/L para alternar fun√ß√µes.")
    
else
    -- ==============================================
    -- MODO PC: apenas teclas (sem UI adicional)
    -- ==============================================
    UserInputService.InputBegan:Connect(function(input, gpe)
        if gpe then return end
        
        if input.KeyCode == Enum.KeyCode.P then
            _G.CamLockEnabled = not _G.CamLockEnabled
            if _G.CameraLock then
                _G.CameraLock(_G.CamLockEnabled)
            end
            print("üì∑ Camera Lock:", _G.CamLockEnabled and "ON" or "OFF")
            
        elseif input.KeyCode == Enum.KeyCode.L then
            _G.CharLockEnabled = not _G.CharLockEnabled
            if _G.CharacterLock then
                _G.CharacterLock(_G.CharLockEnabled)
            end
            print("üë§ Character Lock:", _G.CharLockEnabled and "ON" or "OFF")
        end
    end)
    
    print("üíª PC mode: Pressione P (Cam) ou L (Character)")
end

-- Recriar UI quando o personagem renascer (mobile)
if isMobile() then
    player.CharacterAdded:Connect(function()
        task.wait(2)
        -- A UI ser√° recriada no spawn, mas precisamos garantir que o bot√£o original reapare√ßa
        -- Por simplicidade, apenas recarregamos o script inteiro (ou podemos reexecutar a l√≥gica)
        -- Neste caso, vamos simplesmente chamar cleanup e recriar.
        cleanup()
        -- O c√≥digo acima ser√° executado novamente? N√£o, porque j√° est√° fora do evento.
        -- Uma solu√ß√£o pr√°tica √© colocar todo o c√≥digo mobile em uma fun√ß√£o e cham√°-la.
        -- Vamos reestruturar rapidamente:
    end)
end
