local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local Stats = game:GetService("Stats")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- // 1. BUSCA AUTOMÁTICA (PEGA QUALQUER BILLBOARDGUI)
local gui = nil
for i = 1, 100 do
    gui = player.PlayerGui:FindFirstChildOfClass("BillboardGui")
    if gui then break end
    task.wait(0.1)
end

if not gui then return end

-- // 2. CONFIGURAÇÃO AUTOMÁTICA DA GUI
gui.AlwaysOnTop = true
gui.Enabled = true

-- // 3. HUD DE TELA PARA UTILIDADES
local screenHUD = player.PlayerGui:FindFirstChild("Apex_Screen") or Instance.new("ScreenGui")
screenHUD.Name = "Apex_Screen"
screenHUD.ResetOnSpawn = false
screenHUD.Parent = player.PlayerGui

-- // 4. ESTADOS E VARIAVEIS
local targetOffset = Vector3.new(2.8, 1.4, -4.5)
local currentOffset = targetOffset
local states = {isOutside = false, locked = false, fly = false, noclip = false, infJump = false}

local char, hum, root, head
local function updateRefs(c)
    if not c then return end
    char = c
    hum = c:WaitForChild("Humanoid", 20)
    root = c:WaitForChild("HumanoidRootPart", 20)
    head = c:WaitForChild("Head", 20)
    if not states.locked then gui.Adornee = head end
end
updateRefs(player.Character)
player.CharacterAdded:Connect(updateRefs)

-- // 5. INTELIGÊNCIA ARTIFICIAL DE INTERFACE (Acha os textos e botões sozinho)
local function getElement(name)
    return gui:FindFirstChild(name, true) or screenHUD:FindFirstChild(name, true)
end

local function updateTelemetry()
    pcall(function()
        local fps = math.floor(Stats.WorkspaceResources.FPS:GetValue())
        local ping = math.floor(player:GetNetworkPing()*1000)
        local pos = root.Position
        
        -- Procura qualquer TextLabel que pareça ser de Coords ou Stats
        for _, v in ipairs(gui:GetDescendants()) do
            if v:IsA("TextLabel") or v:IsA("TextBox") then
                if v.Name:lower():find("coord") or v.Name:lower():find("pos") then
                    v.Text = string.format("%.0f, %.0f, %.0f", pos.X, pos.Y, pos.Z)
                elseif v.Name:lower():find("fps") or v.Name:lower():find("stat") or v.Name:lower():find("ms") then
                    v.Text = fps .. " FPS | " .. ping .. "ms"
                end
            end
        end
    end)
end

-- // 6. TRANSIÇÃO AUTOMÁTICA (DETACH)
local function toggleOutside()
    states.isOutside = not states.isOutside
    -- Pega o primeiro Frame grande que não seja o de info
    local utils = gui:FindFirstChild("UtilsFrame", true) or gui:FindFirstChildOfClass("ScrollingFrame") or gui:FindFirstChildOfClass("Frame")
    
    if utils then
        if states.isOutside then
            utils.Parent = screenHUD
            utils.Position = UDim2.new(0.05, 0, 0.4, 0)
        else
            utils.Parent = gui:FindFirstChildOfClass("ScrollingFrame") or gui
            utils.Position = UDim2.new(0, 0, 0, 0)
        end
    end
end

-- // 7. LOOP PRINCIPAL (AR + 1ª PESSOA)
RunService.RenderStepped:Connect(function()
    if not (head and root and gui) then return end
    
    local dist = (camera.CFrame.Position - head.Position).Magnitude
    local isFirstPerson = dist < 1.6
    
    gui.Enabled = isFirstPerson
    screenHUD.Enabled = states.isOutside
    
    if isFirstPerson and not states.locked then
        currentOffset = currentOffset:Lerp(targetOffset, 0.12)
        gui.StudsOffset = currentOffset
    end
    
    updateTelemetry()
    
    if states.noclip then
        for _, v in ipairs(char:GetDescendants()) do
            if v:IsA("BasePart") then v.CanCollide = false end
        end
    end
end)

-- // 8. CONEXÃO DE BOTÕES (BUSCA POR NOME OU TIPO)
local function autoBind()
    local buttons = {
        ["Detach"] = toggleOutside,
        ["Speed"] = function() if hum then hum.WalkSpeed = 65 end end,
        ["Fly"] = function()
            states.fly = not states.fly
            if states.fly then
                task.spawn(function()
                    local bv = Instance.new("BodyVelocity", root)
                    bv.MaxForce = Vector3.new(1,1,1)*math.huge
                    while states.fly and root do
                        bv.Velocity = camera.CFrame.LookVector * 75
                        task.wait()
                    end
                    bv:Destroy()
                end)
            end
        end,
        ["Noclip"] = function() states.noclip = not states.noclip end,
        ["Lock"] = function() states.locked = not states.locked end
    }

    for name, func in pairs(buttons) do
        local btn = getElement(name .. "Btn") or getElement(name)
        if btn and (btn:IsA("TextButton") or btn:IsA("ImageButton")) then
            btn.Activated:Connect(func)
        end
    end
end

-- // 9. SEGURANÇA CONTRA DETECÇÃO (RONIX/EUREKA)
pcall(function()
    local mt = getrawmetatable(game)
    setreadonly(mt, false)
    local old = mt.__index
    mt.__index = newcclosure(function(t, k)
        if not checkcaller() and t == hum and k == "WalkSpeed" then return 16 end
        return old(t, k)
    end)
    setreadonly(mt, true)
end)

-- Iniciar
autoBind()
UIS.JumpRequest:Connect(function() if states.infJump and hum then hum:ChangeState(3) end end)
